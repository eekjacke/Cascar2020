# cascar = Control Autonomous Systems CAR

> ROS code for controlling the RCCar platform @ Vehicular Systems to be used in 
> the upcoming course in Learning, Planning, and Control of Autonomous vehicles.

*This repo should be within your worspace/src folder.*

### UPDATES 2020

Updated library to function with latest release (Noetic) with python3 standard.

Added code to read MPU5060 imu.

Added packages for Qualisys and Rplidar in the repo.

## Network

Wifi hotspot is usually created automatically, named in format ```cascar_X```.
Password: _tsfs12autonom_

Connect to the hotspot with your laptop


## ROS master/client configuration

For ROS nodes to find each other, some environment variables (```ROS_IP```, ```ROS_MASTER_URI```) should be properly configured to match the used network.

### Master

The master node could be configured by:
```bash
source ~/cascar_ws/src/cascar/develop/conf_scripts/setrosmaster.sh
```

In the script, IP address which is assigned to WiFi interface (```wlan0```) is parsed and inserted into two export commands defining the needed environment variables.
The master node has enough information to setup all variable by its own.

One could manually check which IP address is assigned to the master node and configure environment variables on the clients. Or use the provided scripts which work under the assumption that all nodes are located inside one subnetwork, meaning that the nodes could communicate via broadcast messages.

The master runs ```rosmasterip.service```, which gets broadcast messages from clients and replies to them, so they could find out the master IP address. The service is based on a small Python program, ```rosmasterip.py```.

### Client

When ```rosmasterip.service``` is running and the master and the clients are on the same network, each client could set up its environment variables with:
```bash
  source  ~/cascar_ws/src/cascar/develop/conf_scripts/setrosclient.sh
```

The script runs ```rosclientip.py```  to obtain the master node IP and creates ```envrosip.sh``` with the suitable environment variables, which are later sourced by the script.

## Initialize the car

To SSH the car

```bash
ssh cascar@$ROS_MASTER_IP
```

Run one of the lines to initialize the car (```roscore``` would start automatically if it is not running yet)

```bash
roslaunch cascar cascar_dead_reck.launch #no lidar
roslaunch cascar cascar_full.launch #with lidar
```

## Command line interface

Run on the client side, it is possible to run it on the master side as well.

To see the topics and check that ```/car_command``` topic is available

```bash
rostopic list
```

To publish a command to the car from the terminal

```bash
rostopic pub /car_command cascar/CarCommand "velocity: 50.0
steer: 0.0"
```

(typically problematic with spaces, works better just to type ```rostopic pub /car_command``` and then press ```Tab``` button several types to autocomplete the command)

In a separate window by running

```bash
rostopic echo /odom
```

you could see odometry messages published when the cars is moving

## ROS examples code

Two example scripts are provided with basic ROS functionality that can be used as starting points for you own development.

More general examples can be found at the [ROS wiki page](http://wiki.ros.org/ROS/Tutorials). In particular this [example](http://wiki.ros.org/ROS/Tutorials/WritingPublisherSubscriber%28python%29) is worth studying.

Both example scripts are within the __playground__ folder within the ROS workspace.

### cascar_test_node.py

Once executed, this script sends commands to the command with a particular frequency: ```cascar_test_node.py```

It is possible to run it as

```bash
python3 cascar_test_node.py
```

However, to make it to a “real” node, you need to make it executable

```bash
chmod +x  cascar_test_node.py
```

After that it should be possible to start the node by

```bash
rosrun cascar cascar_test_node.py
```

### lidar_reader.py

This example will give you some insight into how to manipulate the data generated by the RPlidar. 

The function is a follows: Once scans are available, each range recording is converted into a cartesian point that will provide information of obstacles in the vehicle's relative coordinate frame.

Execution of the lidar_reader node can be done in the same manner as described above.

There is plenty of information to be gathered from a scan message, more information can be found [here](http://docs.ros.org/api/sensor_msgs/html/msg/LaserScan.html).